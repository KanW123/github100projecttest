name: Generate Image

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: '画像生成プロンプト'
        required: true
        default: 'A cute robot character in pixel art style'
      provider:
        description: 'プロバイダー'
        required: true
        default: 'openai'
        type: choice
        options:
          - openai
          - gemini
      reference_image:
        description: '参照画像パス (例: ImageGenerator/generated/2026-01-21/img_xxx.png)'
        required: false
        default: ''
      input_fidelity:
        description: '参照画像の忠実度 (high=特徴を強く維持)'
        required: false
        default: 'high'
        type: choice
        options:
          - high
          - low

# Prevent concurrent runs to avoid commit conflicts
concurrency:
  group: image-generation
  cancel-in-progress: false

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Generate image with OpenAI (with reference)
        if: ${{ inputs.provider == 'openai' && inputs.reference_image != '' }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PROMPT: ${{ inputs.prompt }}
          REF_IMAGE: ${{ inputs.reference_image }}
          INPUT_FIDELITY: ${{ inputs.input_fidelity }}
        run: |
          echo "Generating image with OpenAI (image reference mode)..."
          echo "Prompt: $PROMPT"
          echo "Reference: $REF_IMAGE"
          echo "Input Fidelity: $INPUT_FIDELITY"

          # Check if reference image exists
          if [ ! -f "$REF_IMAGE" ]; then
            echo "Error: Reference image not found: $REF_IMAGE"
            exit 1
          fi

          # Use /v1/images/edits endpoint with image reference
          echo "Calling /v1/images/edits..."
          echo "Reference file size: $(stat -c%s "$REF_IMAGE" 2>/dev/null || stat -f%z "$REF_IMAGE") bytes"

          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST "https://api.openai.com/v1/images/edits" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -F "model=gpt-image-1" \
            -F "image=@$REF_IMAGE" \
            -F "prompt=$PROMPT" \
            -F "size=1024x1024")

          HTTP_CODE=$(echo "$RESPONSE" | grep -o 'HTTP_CODE:[0-9]*' | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed 's/HTTP_CODE:[0-9]*$//')

          echo "HTTP Code: $HTTP_CODE"
          echo "Response Body: $BODY"

          # Check for error
          ERROR=$(echo "$BODY" | jq -r '.error.message // empty')
          if [ -n "$ERROR" ]; then
            echo "API Error: $ERROR"
            exit 1
          fi

          # Extract base64 data (edits endpoint returns b64_json)
          IMAGE_B64=$(echo "$BODY" | jq -r '.data[0].b64_json // empty')
          IMAGE_URL=$(echo "$BODY" | jq -r '.data[0].url // empty')

          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          mkdir -p ImageGenerator/generated/$(date +%Y-%m-%d)
          OUTPUT_PATH="ImageGenerator/generated/$(date +%Y-%m-%d)/img_${TIMESTAMP}.png"

          if [ -n "$IMAGE_B64" ] && [ "$IMAGE_B64" != "null" ]; then
            echo "Decoding base64..."
            echo "$IMAGE_B64" | base64 -d > "$OUTPUT_PATH"
          elif [ -n "$IMAGE_URL" ] && [ "$IMAGE_URL" != "null" ]; then
            echo "Downloading from URL..."
            curl -s "$IMAGE_URL" -o "$OUTPUT_PATH"
          else
            echo "Error: No image data in response"
            echo "$BODY" | jq .
            exit 1
          fi

          echo "Image saved to: $OUTPUT_PATH"
          echo "OUTPUT_PATH=$OUTPUT_PATH" >> $GITHUB_ENV

          # Save metadata
          cat > "${OUTPUT_PATH%.png}_meta.json" << METAEOF
          {
            "prompt": "$PROMPT",
            "provider": "openai",
            "model": "gpt-image-1",
            "mode": "edit_with_reference",
            "reference_image": "$REF_IMAGE",
            "input_fidelity": "$INPUT_FIDELITY",
            "created": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "quality": "medium"
          }
          METAEOF

      - name: Generate image with OpenAI (no reference)
        if: ${{ inputs.provider == 'openai' && inputs.reference_image == '' }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PROMPT: ${{ inputs.prompt }}
        run: |
          echo "Generating image with OpenAI (text-only mode)..."
          echo "Prompt: $PROMPT"

          # Use jq to safely create JSON
          JSON_PAYLOAD=$(jq -n \
            --arg prompt "$PROMPT" \
            '{
              model: "gpt-image-1",
              prompt: $prompt,
              size: "1024x1024",
              n: 1
            }')

          echo "Payload: $JSON_PAYLOAD"

          RESPONSE=$(curl -s -X POST "https://api.openai.com/v1/images/generations" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD")

          echo "Response: $RESPONSE"

          # Extract image URL or base64 data
          IMAGE_URL=$(echo "$RESPONSE" | jq -r '.data[0].url // empty')
          IMAGE_B64=$(echo "$RESPONSE" | jq -r '.data[0].b64_json // empty')

          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          mkdir -p ImageGenerator/generated/$(date +%Y-%m-%d)
          OUTPUT_PATH="ImageGenerator/generated/$(date +%Y-%m-%d)/img_${TIMESTAMP}.png"

          if [ -n "$IMAGE_URL" ]; then
            echo "Downloading from URL..."
            curl -s "$IMAGE_URL" -o "$OUTPUT_PATH"
          elif [ -n "$IMAGE_B64" ]; then
            echo "Decoding base64..."
            echo "$IMAGE_B64" | base64 -d > "$OUTPUT_PATH"
          else
            echo "Error: No image data in response"
            echo "$RESPONSE"
            exit 1
          fi

          echo "Image saved to: $OUTPUT_PATH"
          echo "OUTPUT_PATH=$OUTPUT_PATH" >> $GITHUB_ENV

          # Save metadata
          cat > "${OUTPUT_PATH%.png}_meta.json" << METAEOF
          {
            "prompt": "$PROMPT",
            "provider": "openai",
            "model": "gpt-image-1",
            "mode": "text_only",
            "created": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "quality": "medium"
          }
          METAEOF

      - name: Generate image with Gemini
        if: ${{ inputs.provider == 'gemini' }}
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          echo "Generating image with Gemini..."
          # Gemini image generation implementation
          # TODO: Add Gemini API call when needed
          echo "Gemini generation not yet implemented"
          exit 1

      - name: Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add ImageGenerator/generated/
          git commit -m "Generate image: ${{ inputs.prompt }}" || echo "No changes to commit"

          # Retry push with rebase on conflict (up to 5 attempts)
          for i in 1 2 3 4 5; do
            echo "Push attempt $i..."
            if git push; then
              echo "Push successful!"
              break
            else
              echo "Push failed, pulling with rebase..."
              git pull --rebase origin main || true
              sleep $((i * 2))
            fi
          done
